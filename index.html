<!DOCTYPE html>
<!--
  Copyright 2010 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)

  html5-slides-markdown Modifications: Adam Zapletal (adamzap@gmail.com)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>gevent</title>
    <style type = "text/css">
        body {
          background: #778;
          padding: 0;
          margin: 0;
          overflow: hidden;
        }

        div.presentation {
          position: absolute;
          width: 100%;
          display: table-cell;
          vertical-align: middle;
          height: 100%;
          background: inherit;
        }

        div.slides {
          width: 100%;
          height: 100%;
          overflow: hidden;
          left: 0;
          top: 0;
          position: absolute;
          display: block;
          -webkit-transition: -webkit-transform 1s ease-in-out;
          -moz-transition: -moz-transform 1s ease-in-out;
          -o-transition: -o-transform 1s ease-in-out;
        }

        p {
            margin-top: 0.3em;
        }
        strong {
            color: red;
        }

        div.slide {
          display: none;
          position: absolute;
          overflow: hidden;
          width: 900px;
          height: 700px;
          left: 50%;
          top: 50%;
          margin-top: -350px;
          background: -webkit-gradient(linear, left bottom, left top, from(#bbd), to(#fff));
          -webkit-transition: margin 0.25s ease-in-out;
          background-color: #eee;
          background: -moz-linear-gradient(bottom, #bbd, #fff);
          -moz-transition: margin 0.25s ease-in-out;
          -o-transition: margin 0.25s ease-in-out;
          border-top-left-radius: 20px;
          -moz-border-radius-topleft: 20px;
          -webkit-border-top-left-radius: 20px;
          border-top-right-radius: 20px;
          -moz-border-radius-topright: 20px;
          -webkit-border-top-right-radius: 20px;
          border-bottom-right-radius: 20px;
          -moz-border-radius-bottomright: 20px;
          -webkit-border-bottom-right-radius: 20px;
          border-bottom-left-radius: 20px;
          -moz-border-radius-bottomleft: 20px;
          -webkit-border-bottom-left-radius: 20px;
        }

        div.slide p {
          font-size: 32px;
        }

        .slide.far-past {
          display: block;
          margin-left: -2400px;
        }

        .slide.past {
          display: block;
          margin-left: -1400px;
        }

        .slide.current {
          display: block;
          margin-left: -450px;
        }

        .slide.future {
          display: block;
          margin-left: 500px;
        }

        .slide.far-future {
          display: block;
          margin-left: 1500px;
        }

        body.three-d div.slides {
          -webkit-transform: translateX(50px) scale(0.8) rotateY(10deg);
          -moz-transform: translateX(50px) scale(0.8) rotateY(10deg);
          -o-transform: translateX(50px) scale(0.8) rotateY(10deg);
        }


        /* Content */

        header:not(:only-child) {
          font-family: 'Lucida Grande';
          font-weight: normal;
          font-size: 60px;
          letter-spacing: -.05em;
          color: white;
          color: black;
          text-shadow: rgba(0, 0, 0, 0.2) 0 2px 5px;
          position: absolute;
          left: 30px;
          top: 25px;
          margin: 0;
          padding: 0;
        }

        h1 {
          display: inline;
          font-size: 56px;
          font-weight: normal;
          padding: 0;
          margin: 0;
        }

        h2 {
          color: black;
          font-size: 36px;
          padding: 0;
          margin: 30px 0px 0px 0px;
        }

        h2:first-child {
          margin-top: 20px;
        }

        section, .slide header:only-child h1 {
          font-family: 'Lucida Grande';
          color: #3f3f3f;
          text-shadow: rgba(0, 0, 0, 0.2) 0 2px 5px;
          margin-left: 30px;
          margin-right: 30px;
          margin-top: 100px;
          display: block;
          overflow: hidden;
        }

        a {
          color: inherit;
          display: inline-block;
          text-decoration: none;
          line-height: 110%;
          border-bottom: 2px solid #3f3f3f;
        }

        pre {
          font-size: 18px;
          font-family: Monaco, Courier, monospace;
        }

        ul {
            margin: 5px;
        }
        li {
          padding: 10px 0;
          font-size: 32px;
        }

        section.title, .slide header:only-child h1 {
          line-height: 180%;
          text-align: center;
          display: table-cell;
          vertical-align: middle;
          height: 700px;
          width: 900px;
        }

        section.title p:only-child {
          font-size: 120px;
          margin-top:100px;
          margin-bottom:100px;
        }
        .slide header:only-child h1 {
          font-size: 64px;
          margin-top:100px;
          margin-bottom:100px;
        }
    </style>
    <script>
        function main() {
          // Since we don't have the fallback of attachEvent and
          // other IE only stuff we won't try to run JS for IE.
          // It will run though when using Google Chrome Frame
          if (document.all) { return; }

          var currentSlideNo;
          var notesOn = false;
          var slides = document.getElementsByClassName('slide');
          var touchStartX = 0;

          // var slide_hash = window.location.hash.replace(/#/, '');
          // if (slide_hash) {
          //   for (var i = 0, len = slides.length; i < len; i++) {
          //     if (slides[i].id == slide_hash) {
          //       currentSlideNo = i;
          //       updateSlideClasses();
          //     }
          //   }
          // }

          var spaces = /\s+/, a1 = [""];

          var str2array = function(s) {
            if (typeof s == "string" || s instanceof String) {
              if (s.indexOf(" ") < 0) {
                a1[0] = s;
                return a1;
              } else {
                return s.split(spaces);
              }
            }
            return s;
          };

          var trim = function(str) {
            return str.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
          };

          var addClass = function(node, classStr) {
            classStr = str2array(classStr);
            var cls = " " + node.className + " ";
            for (var i = 0, len = classStr.length, c; i < len; ++i) {
              c = classStr[i];
              if (c && cls.indexOf(" " + c + " ") < 0) {
                cls += c + " ";
              }
            }
            node.className = trim(cls);
          };

          var removeClass = function(node, classStr) {
            var cls;
            if (classStr !== undefined) {
              classStr = str2array(classStr);
              cls = " " + node.className + " ";
              for (var i = 0, len = classStr.length; i < len; ++i) {
                cls = cls.replace(" " + classStr[i] + " ", " ");
              }
              cls = trim(cls);
            } else {
              cls = "";
            }
            if (node.className != cls) {
              node.className = cls;
            }
          };

          var getSlideEl = function(slideNo) {
            if (slideNo > 0) {
              return slides[slideNo - 1];
            } else {
              return null;
            }
          };

          var getSlideTitle = function(slideNo) {
            var el = getSlideEl(slideNo);

            if (el) {
              return el.getElementsByTagName('header')[0].innerHTML;
            } else {
              return null;
            }
          };

          var changeSlideElClass = function(slideNo, className) {
            var el = getSlideEl(slideNo);

            if (el) {
              removeClass(el, 'far-past past current future far-future');
              addClass(el, className);
            }
          };

          var updateSlideClasses = function() {
            window.location.hash = "slide" + currentSlideNo;
            changeSlideElClass(currentSlideNo - 2, 'far-past');
            changeSlideElClass(currentSlideNo - 1, 'past');
            changeSlideElClass(currentSlideNo, 'current');
            changeSlideElClass(currentSlideNo + 1, 'future');
            changeSlideElClass(currentSlideNo + 2, 'far-future');
          };

          var nextSlide = function() {
            if (currentSlideNo < slides.length) {
              currentSlideNo++;
            }

            updateSlideClasses();
          };

          var prevSlide = function() {
            if (currentSlideNo > 1) {
              currentSlideNo--;
            }
            updateSlideClasses();
          };

          var showNotes = function() {
            var notes = document.querySelectorAll('.notes');
            for (var i = 0, len = notes.length; i < len; i++) {
              notes[i].style.display = (notesOn) ? 'none':'block';
            }
            notesOn = (notesOn) ? false:true;
          };

          var switch3D = function() {
            if (document.body.className.indexOf('three-d') == -1) {
              document.getElementsByClassName('presentation')[0].style.webkitPerspective = '1000px';
              document.body.className += ' three-d';
            } else {
              window.setTimeout("document.getElementsByClassName('presentation')[0].style.webkitPerspective = '0';", 2000);
              document.body.className = document.body.className.replace(/three-d/, '');
            }
          };

          var handleBodyKeyDown = function(event) {
            // console.log(event.keyCode);
            switch (event.keyCode) {
              case 37: // left arrow
                prevSlide();
                break;
              case 39: // right arrow
              // case 32: // space
                nextSlide();
                break;
              case 50: // 2
                showNotes();
                break;
              case 51: // 3
                switch3D();
                break;
            }
          };

          var addTouchListeners = function() {
            document.addEventListener('touchstart', function(e) {
              touchStartX = e.touches[0].pageX;
            }, false);
            document.addEventListener('touchend', function(e) {
              var pixelsMoved = touchStartX - e.changedTouches[0].pageX;
              var SWIPE_SIZE = 150;
              if (pixelsMoved > SWIPE_SIZE) {
                nextSlide();
              }
              else if (pixelsMoved < -SWIPE_SIZE) {
               prevSlide();
              }
            }, false);
          };

          // initialize

          (function() {
            if (window.location.hash != "") {
              currentSlideNo = Number(window.location.hash.replace('#slide', ''));
            } else {
              currentSlideNo = 1;
            }

            document.addEventListener('keydown', handleBodyKeyDown, false);

            var els = slides;
            for (var i = 0, el; el = els[i]; i++) {
              addClass(el, 'slide far-future');
            }
            updateSlideClasses();

            // add support for finger events (filter it by property detection?)
            addTouchListeners();
          })();
        };
    </script>
</head>
<body>
    <div class="presentation">
      <div class="slides">
        <div class="slide">
            <section class="title"><p>gevent</p>
</section>
        </div>
        
          <div class="slide">
              <header><h1>お前誰よ</h1></header>
              
                  <section><p>稲田 直哉 (@methane)</p>
<p>KLab株式会社</p>
<p>msgpack-python</p>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>Summary</h1></header>
              
                  <section><ul>
<li><big>gevent って何?</big></li>
<li><big>どう使うの?</big></li>
<li><big>他の方法と比べてどうなの?</big></li>
</ul>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>gevent って何?</h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>gevent = libev x greenlet</h1></header>
              
                  <section><h2>libev</h2>
<p>クロスプラットフォームな
イベントドリブンプログラミング
効率のいい <strong>IO多重化</strong> を実現</p>
<h2>greenlet</h2>
<p>軽量スレッド</p>
<h2>gevent</h2>
<p>2つを組み合わせて <strong>簡単かつ効率のいいIO多重化</strong> を実現</p>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>IO多重化</h1></header>
              
                  <section><p>複数のIO処理を並行に行う.</p>
<h2>blocking + thread</h2>
<p>並行処理のためにスレッドを使う.</p>
<p>IO待ちのためにスレッドを止める(ブロック)</p>
<h2>nonblocking + event driven</h2>
<p>複数のIO待ちをまとめて監視 (select, epoll, kqueue)</p>
<p>実行可能になったIOを処理する.</p>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>echoサーバーを作ろう</h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>IO多重化なし</h1></header>
              
                  <section><pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">socket</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">echo</span>(sock):
    <span style="color: #008000; font-weight: bold">try</span>:
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
            data <span style="color: #666666">=</span> sock<span style="color: #666666">.</span>recv(<span style="color: #666666">1024</span>) <span style="color: #408080; font-style: italic"># 受信できるまでブロック</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> data:
                <span style="color: #008000; font-weight: bold">break</span>
            sock<span style="color: #666666">.</span>sendall(data) <span style="color: #408080; font-style: italic"># 送信できるまでブロック</span>
    <span style="color: #008000; font-weight: bold">finally</span>:
        sock<span style="color: #666666">.</span>close()

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">serve</span>(addr):
    sock <span style="color: #666666">=</span> socket<span style="color: #666666">.</span>socket()
    sock<span style="color: #666666">.</span>bind(addr); sock<span style="color: #666666">.</span>listen(<span style="color: #666666">50</span>)
    <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
        conn, _ <span style="color: #666666">=</span> sock<span style="color: #666666">.</span>accept() <span style="color: #408080; font-style: italic"># 接続されるまでブロック</span>
        echo(conn) <span style="color: #408080; font-style: italic"># 接続が終わるまでブロック</span>

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    serve((<span style="color: #BA2121">&#39;0.0.0.0&#39;</span>, <span style="color: #666666">4000</span>))
</pre></div>
</pre>
<p><strong>1クライアントとしか通信できない</strong></p>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>スレッド</h1></header>
              
                  <section><pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">socket</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">threading</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">echo</span>(sock):
    <span style="color: #008000; font-weight: bold">try</span>:
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
            data <span style="color: #666666">=</span> sock<span style="color: #666666">.</span>recv(<span style="color: #666666">1024</span>) <span style="color: #408080; font-style: italic"># 受信できるまでブロック</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> data:
                <span style="color: #008000; font-weight: bold">break</span>
            sock<span style="color: #666666">.</span>sendall(data) <span style="color: #408080; font-style: italic"># 送信できるまでブロック</span>
    <span style="color: #008000; font-weight: bold">finally</span>:
        sock<span style="color: #666666">.</span>close()

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">serve</span>(addr):
    sock <span style="color: #666666">=</span> socket<span style="color: #666666">.</span>socket()
    sock<span style="color: #666666">.</span>bind(addr); sock<span style="color: #666666">.</span>listen(<span style="color: #666666">50</span>)
    <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
        conn, _ <span style="color: #666666">=</span> sock<span style="color: #666666">.</span>accept()
        <span style="color: #408080; font-style: italic"># クライアントごとにスレッドを立ち上げて並行処理</span>
        threading<span style="color: #666666">.</span>Thread(target<span style="color: #666666">=</span>echo, args<span style="color: #666666">=</span>(conn,))<span style="color: #666666">.</span>start()

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    serve((<span style="color: #BA2121">&#39;0.0.0.0&#39;</span>, <span style="color: #666666">4000</span>))
</pre></div>
</pre>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>nonblocking + select (1)</h1></header>
              
                  <section><pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">socket</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">select</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">errno</span>

read_handlers <span style="color: #666666">=</span> {}
write_handlers <span style="color: #666666">=</span> {}

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">call_handlers</span>(handlers, fds):
    <span style="color: #008000; font-weight: bold">for</span> fd <span style="color: #AA22FF; font-weight: bold">in</span> fds:
        <span style="color: #008000; font-weight: bold">try</span>:
            handlers[fd]()
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">IOError</span> <span style="color: #008000; font-weight: bold">as</span> e:
            <span style="color: #008000; font-weight: bold">if</span> e<span style="color: #666666">.</span>errno <span style="color: #AA22FF; font-weight: bold">in</span> (errno<span style="color: #666666">.</span>EAGAIN, errno<span style="color: #666666">.</span>EWOULDBLOCK):
                <span style="color: #008000; font-weight: bold">continue</span>
        <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">KeyError</span>:
            <span style="color: #008000; font-weight: bold">pass</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">loop</span>():
    <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
        reads, writes, _ <span style="color: #666666">=</span> select<span style="color: #666666">.</span>select(
                read_handlers<span style="color: #666666">.</span>keys(),
                write_handlers<span style="color: #666666">.</span>keys(),
                [])
        call_handlers(read_handlers, reads)
        call_handlers(write_handlers, writes)
</pre></div>
</pre>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>nonblocking + select (2)</h1></header>
              
                  <section><pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">ServerHandler</span>(<span style="color: #008000">object</span>):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, sock):
        sock<span style="color: #666666">.</span>setblocking(<span style="color: #666666">0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>sock <span style="color: #666666">=</span> sock
        read_handlers[sock<span style="color: #666666">.</span>fileno()] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>on_readable

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">on_readable</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
            conn, _ <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>sock<span style="color: #666666">.</span>accept()
            EchoHandler(conn)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">serve</span>(addr):
    sock <span style="color: #666666">=</span> socket<span style="color: #666666">.</span>socket()
    sock<span style="color: #666666">.</span>bind(addr)
    sock<span style="color: #666666">.</span>listen(<span style="color: #666666">50</span>)
    ServerHandler(sock)
    loop()

<span style="color: #408080; font-style: italic">#...</span>

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    serve((<span style="color: #BA2121">&#39;0.0.0.0&#39;</span>, <span style="color: #666666">4000</span>))
</pre></div>
</pre>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>nonblocking + select (3)</h1></header>
              
                  <section><pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">EchoHandler</span>(<span style="color: #008000">object</span>):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, sock):
        sock<span style="color: #666666">.</span>setblocking(<span style="color: #666666">0</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>sock <span style="color: #666666">=</span> sock
        <span style="color: #008000">self</span><span style="color: #666666">.</span>buf <span style="color: #666666">=</span> []
        read_handlers[sock<span style="color: #666666">.</span>fileno()] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>on_readable

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">on_readable</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
                data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>sock<span style="color: #666666">.</span>recv(<span style="color: #666666">4096</span>)
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> data:
                    <span style="color: #008000">self</span><span style="color: #666666">.</span>close()
                    <span style="color: #008000; font-weight: bold">return</span>
                <span style="color: #008000">self</span><span style="color: #666666">.</span>buf<span style="color: #666666">.</span>append(data)
        <span style="color: #008000; font-weight: bold">finally</span>:
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>buf:
                write_handlers[<span style="color: #008000">self</span><span style="color: #666666">.</span>sock<span style="color: #666666">.</span>fileno()] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>on_writable
</pre></div>
</pre>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>nonblocking + select(4)</h1></header>
              
                  <section><pre><div class="highlight"><pre style="line-height: 125%">    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">on_writable</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">try</span>:
            <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>buf:
                data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>buf[<span style="color: #666666">0</span>]
                sent <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>sock<span style="color: #666666">.</span>send(data)
                data <span style="color: #666666">=</span> data[sent:]
                <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> data:
                    <span style="color: #008000">self</span><span style="color: #666666">.</span>buf<span style="color: #666666">.</span>pop(<span style="color: #666666">0</span>)
                <span style="color: #008000; font-weight: bold">else</span>:
                    <span style="color: #008000">self</span><span style="color: #666666">.</span>buf[<span style="color: #666666">0</span>] <span style="color: #666666">=</span> data
        <span style="color: #008000; font-weight: bold">finally</span>:
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>buf:
                write_handlers[<span style="color: #008000">self</span><span style="color: #666666">.</span>sock<span style="color: #666666">.</span>fileno()] <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>on_writable

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">close</span>(<span style="color: #008000">self</span>):
        fd <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>sock<span style="color: #666666">.</span>fileno()
        read_handlers<span style="color: #666666">.</span>pop(fd, <span style="color: #008000">None</span>)
        write_handlers<span style="color: #666666">.</span>pop(fd, <span style="color: #008000">None</span>)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>sock<span style="color: #666666">.</span>close()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>buf <span style="color: #666666">=</span> []
</pre></div>
</pre>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>めんどくさい?</h1></header>
              
                  <section><p>ほとんどが汎用的な処理<br />フレームワーク化可能</p>
<h2>Tornado</h2>
<pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">tornado</span> <span style="color: #008000; font-weight: bold">import</span> ioloop, iostream
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">tornado.netutil</span> <span style="color: #008000; font-weight: bold">import</span> TCPServer

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">EchoServer</span>(TCPServer):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">handle_stream</span>(<span style="color: #008000">self</span>, stream, addr):
        stream<span style="color: #666666">.</span>read_until_close(<span style="color: #008000; font-weight: bold">lambda</span> _: stream<span style="color: #666666">.</span>close(),
                                stream<span style="color: #666666">.</span>write)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">serve</span>(addr):
    server <span style="color: #666666">=</span> EchoServer()
    server<span style="color: #666666">.</span>listen(addr[<span style="color: #666666">1</span>], addr[<span style="color: #666666">0</span>])
    ioloop<span style="color: #666666">.</span>IOLoop<span style="color: #666666">.</span>instance()<span style="color: #666666">.</span>start()

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    serve((<span style="color: #BA2121">&#39;&#39;</span>, <span style="color: #666666">4000</span>))
</pre></div>
</pre>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>geventで多重化</h1></header>
              
                  <section><pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">gevent.monkey</span>; gevent<span style="color: #666666">.</span>monkey<span style="color: #666666">.</span>patch_all()
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">socket</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">threading</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">echo</span>(sock):
    <span style="color: #008000; font-weight: bold">try</span>:
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
            data <span style="color: #666666">=</span> sock<span style="color: #666666">.</span>recv(<span style="color: #666666">1024</span>) <span style="color: #408080; font-style: italic"># 受信できるまでブロック</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> data:
                <span style="color: #008000; font-weight: bold">break</span>
            sock<span style="color: #666666">.</span>sendall(data) <span style="color: #408080; font-style: italic"># 送信できるまでブロック</span>
    <span style="color: #008000; font-weight: bold">finally</span>:
        sock<span style="color: #666666">.</span>close()

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">serve</span>(addr):
    sock <span style="color: #666666">=</span> socket<span style="color: #666666">.</span>socket()
    sock<span style="color: #666666">.</span>bind(addr); sock<span style="color: #666666">.</span>listen(<span style="color: #666666">50</span>)
    <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
        conn, _ <span style="color: #666666">=</span> sock<span style="color: #666666">.</span>accept()
        <span style="color: #408080; font-style: italic"># クライアントごとにスレッドを立ち上げて並行処理</span>
        threading<span style="color: #666666">.</span>Thread(target<span style="color: #666666">=</span>echo, args<span style="color: #666666">=</span>(conn,))<span style="color: #666666">.</span>start()

<span style="color: #008000; font-weight: bold">if</span> __name__ <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;__main__&#39;</span>:
    serve((<span style="color: #BA2121">&#39;0.0.0.0&#39;</span>, <span style="color: #666666">4000</span>))
</pre></div>
</pre>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1><strong>gevent.monkey.patch_all()</strong><br/> するだけ！</h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>greenlet</h1></header>
              
                  <section><p>並行プログラミングのための軽量スレッド</p>
<h2>高効率</h2>
<ul>
<li>スレッドごとに大きなスタックエリアを取らない</li>
<li>スイッチのオーバーヘッドが軽い</li>
<li>高負荷時のスループット低下が無い</li>
</ul>
<h2>協調型(cooperative)</h2>
<ul>
<li>勝手にスイッチしない(スレッドセーフに書きやすい)</li>
</ul>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>todo</h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>...</h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>...</h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>gevent</h1></header>
              
                  <section><pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
    fd, <span style="border: 1px solid #FF0000">イベント</span> <span style="color: #666666">=</span> <span style="border: 1px solid #FF0000">イベントを待つ</span>()
    greenlets[fd]<span style="color: #666666">.</span>switch()
</pre></div>
</pre>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>イベントドリブンプログラミング</h1></header>
              
                  <section><pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">tornado</span> <span style="color: #008000; font-weight: bold">import</span> ioloop

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">EchoHandler</span>(<span style="color: #008000">object</span>):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, sock, loop<span style="color: #666666">=</span><span style="color: #008000">None</span>):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_sock <span style="color: #666666">=</span> sock
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_loop <span style="color: #666666">=</span> loop <span style="color: #AA22FF; font-weight: bold">or</span> ioloop<span style="color: #666666">.</span>IOLoop<span style="color: #666666">.</span>instance()
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_buf <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;&#39;</span>
        loop<span style="color: #666666">.</span>add_handler(sock<span style="color: #666666">.</span>fileno(), <span style="color: #008000">self</span><span style="color: #666666">.</span>handle, loop<span style="color: #666666">.</span>READ)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">handle</span>(<span style="color: #008000">self</span>, fd, event):
        <span style="color: #008000; font-weight: bold">if</span> event <span style="color: #666666">&</span>amp; <span style="color: #008000">self</span><span style="color: #666666">.</span>_loop<span style="color: #666666">.</span>READ:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_buf <span style="color: #666666">+=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_sock<span style="color: #666666">.</span>recv(<span style="color: #666666">1024**2</span>)

        <span style="color: #008000; font-weight: bold">if</span> event <span style="color: #666666">&</span>amp; <span style="color: #008000">self</span><span style="color: #666666">.</span>_loop<span style="color: #666666">.</span>WRITE:
            sent <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_sock<span style="color: #666666">.</span>send(<span style="color: #008000">self</span><span style="color: #666666">.</span>_buf)
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_buf <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_buf[sent:]

        <span style="color: #008000; font-weight: bold">if</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>_buf:
            loop<span style="color: #666666">.</span>update_handler(fd, <span style="color: #008000">self</span><span style="color: #666666">.</span>_loop<span style="color: #666666">.</span>READ<span style="color: #666666">|</span><span style="color: #008000">self</span><span style="color: #666666">.</span>_loop<span style="color: #666666">.</span>WRITE)
        <span style="color: #008000; font-weight: bold">else</span>:
            loop<span style="color: #666666">.</span>update_handler(fd, <span style="color: #008000">self</span><span style="color: #666666">.</span>_loop<span style="color: #666666">.</span>READ)
</pre></div>
</pre>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>非イベントドリブンプログラミング</h1></header>
              
                  <section><pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">EchoHandler</span>(<span style="color: #008000">object</span>):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">__init__</span>(<span style="color: #008000">self</span>, sock):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_sock <span style="color: #666666">=</span> sock
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_buf <span style="color: #666666">=</span> 
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_reader <span style="color: #666666">=</span> threading<span style="color: #666666">.</span>Thread(<span style="color: #008000">self</span><span style="color: #666666">.</span>read)
        <span style="color: #008000">self</span><span style="color: #666666">.</span>_writer <span style="color: #666666">=</span> threading<span style="color: #666666">.</span>Thread(<span style="color: #008000">self</span><span style="color: #666666">.</span>write)
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">read</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
            <span style="color: #008000">self</span>
</pre></div>
</pre>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>html5-slides-markdown</h1></header>
              
                  <section><p>Generates a slideshow using the slides that power
<a href="http://apirocks.com/html5/html5.html">the html5-slides presentation</a>.</p>
<p>A <code>python</code> with the <code>jinja2</code>, <code>markdown</code>, and <code>pygments</code> modules is required.</p>
<h2>Markdown Formatting Instructions</h2>
<ul>
<li>Separate your slides with a horizontal rule (--- in markdown)</li>
<li>Your first slide (title slide) should not have a heading, only <code>&lt;p&gt;</code>s</li>
<li>Your other slides should have a heading that renders to an h1 element</li>
<li>To highlight blocks of code, put !{{lang}} as the first indented line</li>
<li>See the included slides.md for an example</li>
</ul>
<h2>Rendering Instructions</h2>
<ul>
<li>Put your markdown content in a file called <code>slides.md</code></li>
<li>Run <code>python render.py</code></li>
<li>Enjoy your newly generated <code>presentation.html</code></li>
</ul>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>Slide #2</h1></header>
              
                  <section><p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Aenean magna tellus,
fermentum nec venenatis nec, dapibus id metus. Phasellus nulla massa, consequat
nec tempor et, elementum viverra est. Duis sed nisl in eros adipiscing tempor.</p>
<h2>Section #1</h2>
<p>Integer in dignissim ipsum. Integer pretium nulla at elit facilisis eu feugiat
velit consectetur.</p>
<h2>Section #2</h2>
<p>Donec risus tortor, dictum sollicitudin ornare eu, egestas at purus. Cras
consequat lacus vitae lectus faucibus et molestie nisl gravida. Donec tempor,
tortor in varius vestibulum, mi odio laoreet magna, in hendrerit nibh neque eu
eros.</p>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>Middle slide</h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>Slide #3</h1></header>
              
                  <section><p><strong>Hello Gentlemen</strong></p>
<ul>
<li>Mega Man 2</li>
<li>Mega Man 3</li>
<li>Spelunky</li>
<li>Dungeon Crawl Stone Soup</li>
<li>Etrian Odyssey</li>
</ul>
<p><em>Are you prepared to see beyond the veil of reason?</em> - DeceasedCrab</p>
<ul>
<li>Black Cascade</li>
<li>Two Hunters</li>
<li>Diadem of 12 Stars</li>
</ul>
</section>
              
          </div>
        
          <div class="slide">
              <header><h1>Slide #4</h1></header>
              
                  <section><h2>render.py</h2>
<pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">jinja2</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">markdown</span>

<span style="color: #008000; font-weight: bold">with</span> <span style="color: #008000">open</span>(<span style="color: #BA2121">&#39;presentation.html&#39;</span>, <span style="color: #BA2121">&#39;w&#39;</span>) <span style="color: #008000; font-weight: bold">as</span> outfile:
    slides_src <span style="color: #666666">=</span> markdown<span style="color: #666666">.</span>markdown(<span style="color: #008000">open</span>(<span style="color: #BA2121">&#39;slides.md&#39;</span>)<span style="color: #666666">.</span>read())<span style="color: #666666">.</span>split(<span style="color: #BA2121">&#39;&lt;hr /&gt;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>)

    slides <span style="color: #666666">=</span> []

    <span style="color: #008000; font-weight: bold">for</span> slide_src <span style="color: #AA22FF; font-weight: bold">in</span> slides_src:
        header, content <span style="color: #666666">=</span> slide_src<span style="color: #666666">.</span>split(<span style="color: #BA2121">&#39;</span><span style="color: #BB6622; font-weight: bold">\n</span><span style="color: #BA2121">&#39;</span>, <span style="color: #666666">1</span>)
        slides<span style="color: #666666">.</span>append({<span style="color: #BA2121">&#39;header&#39;</span>: header, <span style="color: #BA2121">&#39;content&#39;</span>: content})

    template <span style="color: #666666">=</span> jinja2<span style="color: #666666">.</span>Template(<span style="color: #008000">open</span>(<span style="color: #BA2121">&#39;base.html&#39;</span>)<span style="color: #666666">.</span>read())

    outfile<span style="color: #666666">.</span>write(template<span style="color: #666666">.</span>render({<span style="color: #BA2121">&#39;slides&#39;</span>: slides}))
</pre></div>
</pre></section>
              
          </div>
        
      </div>
    </div>
    <script>
        main()
    </script>
</body>
</html>
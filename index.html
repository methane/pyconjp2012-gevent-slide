<!DOCTYPE html>
<!--
  Copyright 2010 Google Inc.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

  Original slides: Marcin Wichary (mwichary@google.com)
  Modifications: Ernest Delgado (ernestd@google.com)
                 Alex Russell (slightlyoff@chromium.org)

  html5-slides-markdown Modifications: Adam Zapletal (adamzap@gmail.com)
-->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Gevent</title>
    <style type = "text/css">
        body {
          background: #778;
          padding: 0;
          margin: 0;
          overflow: hidden;
        }

        div.presentation {
          position: absolute;
          width: 100%;
          display: table-cell;
          vertical-align: middle;
          height: 100%;
          background: inherit;
        }

        div.slides {
          width: 100%;
          height: 100%;
          overflow: hidden;
          left: 0;
          top: 0;
          position: absolute;
          display: block;
          -webkit-transition: -webkit-transform 1s ease-in-out;
          -moz-transition: -moz-transform 1s ease-in-out;
          -o-transition: -o-transform 1s ease-in-out;
        }

        p {
            margin-top: 0.3em;
        }
        strong {
            color: red;
        }

        div.slide {
          display: none;
          position: absolute;
          overflow: hidden;
          width: 900px;
          height: 700px;
          left: 50%;
          top: 50%;
          margin-top: -350px;
          background: -webkit-gradient(linear, left bottom, left top, from(#bbd), to(#fff));
          -webkit-transition: margin 0.25s ease-in-out;
          background-color: #eee;
          background: -moz-linear-gradient(bottom, #bbd, #fff);
          -moz-transition: margin 0.25s ease-in-out;
          -o-transition: margin 0.25s ease-in-out;
          border-top-left-radius: 20px;
          -moz-border-radius-topleft: 20px;
          -webkit-border-top-left-radius: 20px;
          border-top-right-radius: 20px;
          -moz-border-radius-topright: 20px;
          -webkit-border-top-right-radius: 20px;
          border-bottom-right-radius: 20px;
          -moz-border-radius-bottomright: 20px;
          -webkit-border-bottom-right-radius: 20px;
          border-bottom-left-radius: 20px;
          -moz-border-radius-bottomleft: 20px;
          -webkit-border-bottom-left-radius: 20px;
        }

        div.left, div.right {
            position: absolute;
            width: 45%;
        }
        div.top { padding-bottom: 20px; }
        div.left { left: 20px; }
        div.right { right: 20px; }

        div.slide p {
          margin-top: 10px;
          margin-bottom: 5px;
          font-size: 32px;
        }

        div.slide table {
          text-align: right;
          font-size: 36px;
          padding: 30px;
          padding-left: 100px;
        }
        td, th {
          padding: 10px;
        }
        th {
          padding-left: 50px;
        }

        .slide.far-past {
          display: block;
          margin-left: -2400px;
        }

        .slide.past {
          display: block;
          margin-left: -1400px;
        }

        .slide.current {
          display: block;
          margin-left: -450px;
        }

        .slide.future {
          display: block;
          margin-left: 500px;
        }

        .slide.far-future {
          display: block;
          margin-left: 1500px;
        }

        body.three-d div.slides {
          -webkit-transform: translateX(50px) scale(0.8) rotateY(10deg);
          -moz-transform: translateX(50px) scale(0.8) rotateY(10deg);
          -o-transform: translateX(50px) scale(0.8) rotateY(10deg);
        }


        /* Content */

        header:not(:only-child) {
          font-family: 'Lucida Grande';
          font-weight: normal;
          font-size: 60px;
          letter-spacing: -.05em;
          color: white;
          color: black;
          text-shadow: rgba(0, 0, 0, 0.2) 0 2px 5px;
          position: absolute;
          left: 30px;
          top: 25px;
          margin: 0;
          padding: 0;
        }

        h1 {
          display: inline;
          font-size: 50px;
          font-weight: normal;
        }

        h2 {
          color: black;
          font-size: 36px;
          padding: 0;
          margin: 30px 0px 0px 0px;
        }

        h2:first-child {
          margin-top: 20px;
        }

        section, .slide header:only-child h1 {
          font-family: 'Lucida Grande';
          color: #3f3f3f;
          text-shadow: rgba(0, 0, 0, 0.2) 0 2px 5px;
          margin-left: 30px;
          margin-right: 30px;
          margin-top: 100px;
          display: block;
          overflow: hidden;
        }

        a {
          color: inherit;
          display: inline-block;
          text-decoration: none;
          line-height: 110%;
          border-bottom: 2px solid #3f3f3f;
        }

        pre {
          font-size: 18px;
          font-family: Monaco, Courier, monospace;
          margin: 15px 0px 0px 10px;
        }

        ul {
            margin: 5px;
            margin-top: 10px;
        }
        li {
          padding: 10px 0;
          font-size: 32px;
        }

        section.title, .slide header:only-child h1 {
          line-height: 180%;
          text-align: center;
          display: table-cell;
          vertical-align: middle;
          height: 700px;
          width: 900px;
        }

        section.title p:only-child {
          font-size: 120px;
          margin-top:100px;
          margin-bottom:100px;
        }
        .slide header:only-child h1 {
          font-size: 64px;
          margin-top:100px;
          margin-bottom:100px;
        }
    </style>
    <script>
        function main() {
          // Since we don't have the fallback of attachEvent and
          // other IE only stuff we won't try to run JS for IE.
          // It will run though when using Google Chrome Frame
          if (document.all) { return; }

          var currentSlideNo;
          var notesOn = false;
          var slides = document.getElementsByClassName('slide');
          var touchStartX = 0;

          // var slide_hash = window.location.hash.replace(/#/, '');
          // if (slide_hash) {
          //   for (var i = 0, len = slides.length; i < len; i++) {
          //     if (slides[i].id == slide_hash) {
          //       currentSlideNo = i;
          //       updateSlideClasses();
          //     }
          //   }
          // }

          var spaces = /\s+/, a1 = [""];

          var str2array = function(s) {
            if (typeof s == "string" || s instanceof String) {
              if (s.indexOf(" ") < 0) {
                a1[0] = s;
                return a1;
              } else {
                return s.split(spaces);
              }
            }
            return s;
          };

          var trim = function(str) {
            return str.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
          };

          var addClass = function(node, classStr) {
            classStr = str2array(classStr);
            var cls = " " + node.className + " ";
            for (var i = 0, len = classStr.length, c; i < len; ++i) {
              c = classStr[i];
              if (c && cls.indexOf(" " + c + " ") < 0) {
                cls += c + " ";
              }
            }
            node.className = trim(cls);
          };

          var removeClass = function(node, classStr) {
            var cls;
            if (classStr !== undefined) {
              classStr = str2array(classStr);
              cls = " " + node.className + " ";
              for (var i = 0, len = classStr.length; i < len; ++i) {
                cls = cls.replace(" " + classStr[i] + " ", " ");
              }
              cls = trim(cls);
            } else {
              cls = "";
            }
            if (node.className != cls) {
              node.className = cls;
            }
          };

          var getSlideEl = function(slideNo) {
            if (slideNo > 0) {
              return slides[slideNo - 1];
            } else {
              return null;
            }
          };

          var getSlideTitle = function(slideNo) {
            var el = getSlideEl(slideNo);

            if (el) {
              return el.getElementsByTagName('header')[0].innerHTML;
            } else {
              return null;
            }
          };

          var changeSlideElClass = function(slideNo, className) {
            var el = getSlideEl(slideNo);

            if (el) {
              removeClass(el, 'far-past past current future far-future');
              addClass(el, className);
            }
          };

          var updateSlideClasses = function() {
            window.location.hash = "slide" + currentSlideNo;
            changeSlideElClass(currentSlideNo - 2, 'far-past');
            changeSlideElClass(currentSlideNo - 1, 'past');
            changeSlideElClass(currentSlideNo, 'current');
            changeSlideElClass(currentSlideNo + 1, 'future');
            changeSlideElClass(currentSlideNo + 2, 'far-future');
          };

          var nextSlide = function() {
            if (currentSlideNo < slides.length) {
              currentSlideNo++;
            }

            updateSlideClasses();
          };

          var prevSlide = function() {
            if (currentSlideNo > 1) {
              currentSlideNo--;
            }
            updateSlideClasses();
          };

          var showNotes = function() {
            var notes = document.querySelectorAll('.notes');
            for (var i = 0, len = notes.length; i < len; i++) {
              notes[i].style.display = (notesOn) ? 'none':'block';
            }
            notesOn = (notesOn) ? false:true;
          };

          var switch3D = function() {
            if (document.body.className.indexOf('three-d') == -1) {
              document.getElementsByClassName('presentation')[0].style.webkitPerspective = '1000px';
              document.body.className += ' three-d';
            } else {
              window.setTimeout("document.getElementsByClassName('presentation')[0].style.webkitPerspective = '0';", 2000);
              document.body.className = document.body.className.replace(/three-d/, '');
            }
          };

          var handleBodyKeyDown = function(event) {
            // console.log(event.keyCode);
            switch (event.keyCode) {
              case 37: // left arrow
                prevSlide();
                break;
              case 39: // right arrow
              // case 32: // space
                nextSlide();
                break;
              case 50: // 2
                showNotes();
                break;
              case 51: // 3
                switch3D();
                break;
            }
          };

          var addTouchListeners = function() {
            document.addEventListener('touchstart', function(e) {
              touchStartX = e.touches[0].pageX;
            }, false);
            document.addEventListener('touchend', function(e) {
              var pixelsMoved = touchStartX - e.changedTouches[0].pageX;
              var SWIPE_SIZE = 150;
              if (pixelsMoved > SWIPE_SIZE) {
                nextSlide();
              }
              else if (pixelsMoved < -SWIPE_SIZE) {
               prevSlide();
              }
            }, false);
          };

          // initialize

          (function() {
            if (window.location.hash != "") {
              currentSlideNo = Number(window.location.hash.replace('#slide', ''));
            } else {
              currentSlideNo = 1;
            }

            document.addEventListener('keydown', handleBodyKeyDown, false);

            var els = slides;
            for (var i = 0, el; el = els[i]; i++) {
              addClass(el, 'slide far-future');
            }
            updateSlideClasses();

            // add support for finger events (filter it by property detection?)
            addTouchListeners();
          })();
        };
    </script>
</head>
<body>
    <div class="presentation">
      <div class="slides">
        <div class="slide">
            <section class="title"><p>Gevent</p>
</section>
        </div>
        
          <div class="slide">
              <header><h1>お前誰よ</h1></header>
              
                
                  <section><p><img src='./icon.jpg' style="right: 30px; top: 30px; position: absolute; width:240px; height:240px;
 border-radius:30px; "></p>
<p>稲田 直哉</p>
<ul>
<li>@methane</li>
<li>msgpack-python</li>
<li>エキスパート Python プログラミング</li>
<li>これから Python 3 の本を書く</li>
</ul>
<p><br />
KLab株式会社</p>
<ul>
<li>スポンサーしてます</li>
<li><strong>We're hiring!</strong></li>
</ul>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>発表資料</h1></header>
              
                
                  <section><ul>
<li>
<p>ソース</p>
<p><small>http://github.com/methane/pyconjp2012-gevent-slide</small></p>
</li>
<li>
<p>スライド</p>
<p><small>http://methane.github.com/pyconjp2012-gevent-slide</small></p>
</li>
</ul>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>Summary</h1></header>
              
                
                  <section><ul>
<li><big>Gevent の目的</big></li>
<li><big>Gevent の特徴</big></li>
<li><big>Gevent の仕組み</big></li>
<li><big>Gevent を使おう</big></li>
</ul>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>Gevent の目的</h1></header>
              
                
                  <section><p><br /></p>
<p><big>簡単かつ効率のいい <strong>IO多重化</strong> </big></p>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>IO多重化とは</h1></header>
              
                
                  <section><p>複数のIO処理を並行に扱うこと.</p>
<ul>
<li>Webアプリ</li>
<li>チャット</li>
<li>複数のファイルの tail</li>
<li>たくさんの<s>エロ</s>画像のダウンロード</li>
</ul>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>IO多重化の手段</h1></header>
              
                
                  <section><h2>blocking IO</h2>
<p>スレッドを止めてIOを待つ</p>
<p>スレッドを複数使うことで多重化</p>
<h2>nonblocking IO</h2>
<p>IOを待たないでエラーを返す.</p>
<p>複数のIOをまとめて待つ(selectなど)ことで多重化</p>
<p>実行可能になったIOに対応する処理を実行する <strong>イベントドリブン</strong> プログラム.</p>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>echoサーバーを作ろう</h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>blocking (多重化なし)</h1></header>
              
                
                  <section><p><strong>1クライアントとしか通信できない</strong></p>
<pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">socket</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">echo</span>(sock):
    <span style="color: #008000; font-weight: bold">try</span>:
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
            data <span style="color: #666666">=</span> sock<span style="color: #666666">.</span>recv(<span style="color: #666666">1024</span>) <span style="color: #408080; font-style: italic"># 受信できるまでブロック</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> data:
                <span style="color: #008000; font-weight: bold">break</span>
            sock<span style="color: #666666">.</span>sendall(data) <span style="color: #408080; font-style: italic"># 送信できるまでブロック</span>
    <span style="color: #008000; font-weight: bold">finally</span>:
        sock<span style="color: #666666">.</span>close()

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">serve</span>(addr):
    sock <span style="color: #666666">=</span> socket<span style="color: #666666">.</span>socket()
    sock<span style="color: #666666">.</span>bind(addr); sock<span style="color: #666666">.</span>listen(<span style="color: #666666">50</span>)
    <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
        conn, _ <span style="color: #666666">=</span> sock<span style="color: #666666">.</span>accept() <span style="color: #408080; font-style: italic"># 接続されるまでブロック</span>
        echo(conn) <span style="color: #408080; font-style: italic"># 終わるまで帰ってこない</span>

serve((<span style="color: #BA2121">&#39;0.0.0.0&#39;</span>, <span style="color: #666666">4000</span>))
</pre></div>
</pre>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>blocking with threading</h1></header>
              
                
                  <section><p><strong>並行処理したい関数をスレッドで包むだけ</strong></p>
<pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">socket</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">threading</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">echo</span>(sock):
    <span style="color: #008000; font-weight: bold">try</span>:
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
            data <span style="color: #666666">=</span> sock<span style="color: #666666">.</span>recv(<span style="color: #666666">1024</span>) <span style="color: #408080; font-style: italic"># 受信できるまでブロック</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> data:
                <span style="color: #008000; font-weight: bold">break</span>
            sock<span style="color: #666666">.</span>sendall(data) <span style="color: #408080; font-style: italic"># 送信できるまでブロック</span>
    <span style="color: #008000; font-weight: bold">finally</span>:
        sock<span style="color: #666666">.</span>close()

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">serve</span>(addr):
    sock <span style="color: #666666">=</span> socket<span style="color: #666666">.</span>socket()
    sock<span style="color: #666666">.</span>bind(addr); sock<span style="color: #666666">.</span>listen(<span style="color: #666666">50</span>)
    <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
        conn, _ <span style="color: #666666">=</span> sock<span style="color: #666666">.</span>accept()
        threading<span style="color: #666666">.</span>Thread(target<span style="color: #666666">=</span>echo, args<span style="color: #666666">=</span>(conn,))<span style="color: #666666">.</span>start()

serve((<span style="color: #BA2121">&#39;0.0.0.0&#39;</span>, <span style="color: #666666">4000</span>))
</pre></div>
</pre>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>nonblocking with select</h1></header>
              
                
                  <section><p><strong>かなり面倒</strong></p>
<p><a href="./echo_select.py"><small>echo_select.py</small></a></p>
<pre><div class="highlight"><pre style="line-height: 125%">    <span style="color: #408080; font-style: italic">#...</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">on_readable</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
            conn, _ <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>sock<span style="color: #666666">.</span>accept()
            EchoHandler(conn)
    <span style="color: #408080; font-style: italic">#...</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">on_readable</span>(<span style="color: #008000">self</span>):
        <span style="color: #008000; font-weight: bold">try</span>:
            data <span style="color: #666666">=</span> <span style="color: #008000">self</span><span style="color: #666666">.</span>sock<span style="color: #666666">.</span>recv(<span style="color: #666666">4096</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> data:
                <span style="color: #008000">self</span><span style="color: #666666">.</span>close()
                <span style="color: #008000; font-weight: bold">return</span>
            <span style="color: #008000">self</span><span style="color: #666666">.</span>buf<span style="color: #666666">.</span>append(data)
        <span style="color: #008000; font-weight: bold">finally</span>:
            <span style="color: #008000">self</span><span style="color: #666666">.</span>_update()
    <span style="color: #408080; font-style: italic">#...</span>
</pre></div>
</pre>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>nonblocking with Tornado</h1></header>
              
                
                  <section><p>基本はコールバック使ったイベントドリブンのまま。</p>
<pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">tornado</span> <span style="color: #008000; font-weight: bold">import</span> ioloop, iostream
<span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">tornado.netutil</span> <span style="color: #008000; font-weight: bold">import</span> TCPServer

<span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">EchoServer</span>(TCPServer):
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">handle_stream</span>(<span style="color: #008000">self</span>, stream, addr):
        stream<span style="color: #666666">.</span>read_until_close(
                <span style="color: #008000; font-weight: bold">lambda</span> _: stream<span style="color: #666666">.</span>close(), <span style="color: #408080; font-style: italic"># 切断時コールバック</span>
                stream<span style="color: #666666">.</span>write, <span style="color: #408080; font-style: italic"># データ受信コールバック</span>
                )

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">serve</span>(addr):
    server <span style="color: #666666">=</span> EchoServer()
    server<span style="color: #666666">.</span>listen(addr[<span style="color: #666666">1</span>], addr[<span style="color: #666666">0</span>])
    ioloop<span style="color: #666666">.</span>IOLoop<span style="color: #666666">.</span>instance()<span style="color: #666666">.</span>start()

serve((<span style="color: #BA2121">&#39;&#39;</span>, <span style="color: #666666">4000</span>))
</pre></div>
</pre>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>Gevent の特徴</h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>Gevent の特徴</h1></header>
              
                
                  <section><ul>
<li>
<p>echoサーバー</p>
</li>
<li>
<p>Gevent vs Threading</p>
<ul>
<li>パフォーマンス対決</li>
</ul>
</li>
<li>
<p>Gevent vs Tornado</p>
<ul>
<li>使いやすさ対決</li>
</ul>
</li>
</ul>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>Gevent で echo サーバー</h1></header>
              
                
                  <section><pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">gevent.server</span> <span style="color: #008000; font-weight: bold">import</span> StreamServer

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">handler</span>(sock, addr):
    <span style="color: #008000; font-weight: bold">try</span>:
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #666666">1</span>:
            buf <span style="color: #666666">=</span> sock<span style="color: #666666">.</span>recv(<span style="color: #666666">4096</span>)
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> buf:
                <span style="color: #008000; font-weight: bold">return</span>
            sock<span style="color: #666666">.</span>sendall(buf)
    <span style="color: #008000; font-weight: bold">finally</span>:
        sock<span style="color: #666666">.</span>close()

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">serve</span>(addr):
    server <span style="color: #666666">=</span> StreamServer(addr, handler, backlog<span style="color: #666666">=1024</span>)
    server<span style="color: #666666">.</span>serve_forever()

serve((<span style="color: #BA2121">&#39;&#39;</span>, <span style="color: #666666">4000</span>))
</pre></div>
</pre>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1><strong>どう見てもblockingなのに、<br />スレッド1つで多重化できる</strong></h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>gevent.monkey.patch_all()</h1></header>
              
                
                  <section><pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">gevent.monkey</span>; gevent<span style="color: #666666">.</span>monkey<span style="color: #666666">.</span>patch_all()
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">socket</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">threading</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">echo</span>(sock):
    <span style="color: #008000; font-weight: bold">try</span>:
        <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
            data <span style="color: #666666">=</span> sock<span style="color: #666666">.</span>recv(<span style="color: #666666">1024</span>) <span style="color: #408080; font-style: italic"># 受信できるまでブロック</span>
            <span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> data:
                <span style="color: #008000; font-weight: bold">break</span>
            sock<span style="color: #666666">.</span>sendall(data) <span style="color: #408080; font-style: italic"># 送信できるまでブロック</span>
    <span style="color: #008000; font-weight: bold">finally</span>:
        sock<span style="color: #666666">.</span>close()

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">serve</span>(addr):
    sock <span style="color: #666666">=</span> socket<span style="color: #666666">.</span>socket()
    sock<span style="color: #666666">.</span>bind(addr); sock<span style="color: #666666">.</span>listen(<span style="color: #666666">50</span>)
    <span style="color: #008000; font-weight: bold">while</span> <span style="color: #008000">True</span>:
        conn, _ <span style="color: #666666">=</span> sock<span style="color: #666666">.</span>accept()
        threading<span style="color: #666666">.</span>Thread(target<span style="color: #666666">=</span>echo, args<span style="color: #666666">=</span>(conn,))<span style="color: #666666">.</span>start()

serve((<span style="color: #BA2121">&#39;0.0.0.0&#39;</span>, <span style="color: #666666">4000</span>))
</pre></div>
</pre>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1><strong>スレッド版のコードが<br />魔法の1行でGevent版に</strong></h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>Gevent vs Threading<br/><small>パフォーマンス対決</small></h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>ベンチマーク</h1></header>
              
                
                  <section><p>echo サーバーに 1000接続から1000回ずつ、</p>
<p>計100万回のメッセージを送受信.</p>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>メモリ使用量(RSS)</h1></header>
              
                
                  <section><p><br /></p>
<p>threading:
34MB</p>
<p>gevent:
26MB</p>
<p>tornado:
12MB</p>
<p>select:
6.1MB</p>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>仮想メモリ使用量(VSS)</h1></header>
              
                
                  <section><p><br /></p>
<p>threading: <strong>3.9GB</strong></p>
<p>gevent: 41MB</p>
<p>tornado: 27MB</p>
<p>select: 21MB</p>
<p><br />
32bit 環境では2GBしかメモリ空間がないので致命的(C10K問題).
64bit 環境では無視できる。</p>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>時間</h1></header>
              
                
                  <section><p><br />
threading:
43sec</p>
<p>gevent:
53sec</p>
<p>tornado:
43sec</p>
<p>select:
25sec</p>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1><strong>Gevent意味あんの？</strong></h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>ベンチマーク2</h1></header>
              
                
                  <section><p>2000接続から50回ずつ、計10万回リクエスト</p>
<p>send の手前で負荷をかけてみる</p>
<pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">stress</span>(): <span style="color: #408080; font-style: italic"># 18.6 ms</span>
    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">rec</span>(n):
        <span style="color: #008000; font-weight: bold">if</span> n:
            <span style="color: #008000; font-weight: bold">return</span> rec(n<span style="color: #666666">-1</span>)
    <span style="color: #008000; font-weight: bold">for</span> i <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">xrange</span>(<span style="color: #666666">100</span>):
        rec(<span style="color: #666666">100</span>)
</pre></div>
</pre>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>結果</h1></header>
              
                
                  <section><table>
<tr>
<td></td>
<th>Gevent</th>
<th>Threading</th>
</tr>
<tr>
<td>RSS</td>
<td>46.1MB</td>
<td>210.5MB</td>
</tr>
<tr>
<td>VSS</td>
<td>46.5MB</td>
<td>7.9GB</td>
</tr>
<tr>
<td>time</td>
<td>3m20sec</td>
<td>10m55sec</td>
</tr>
</table>

<p>スレッドのオーバーヘッド:</p>
<ul>
<li>
<p>深い関数呼び出し =&gt; メモリ使用量が増える</p>
</li>
<li>
<p>CPUを使う処理がたくさん並行する</p>
<p>=&gt; 実行時間が増える</p>
</li>
</ul>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>Gevent vs Threading まとめ</h1></header>
              
                
                  <section><ul>
<li>
<p>たいていスレッドで十分</p>
<p>ワクワクするから Gevent を使うというのはアリ :-)</p>
</li>
<li>
<p>マルチコア・マルチスレッド・高負荷のとき</p>
<p>スレッドのオーバーヘッドが大きい(GIL)場合は、
Gevent の方が安定した性能が出る.</p>
</li>
<li>
<p>メモリを節約したい場面でも有効</p>
</li>
</ul>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>Gevent vs Tornado<br/><small>使いやすさ対決</small></h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>複数の処理を繋げる</h1></header>
              
                
                  <section>
                  <div class="top"><p>イベントドリブンだと処理が細切れになりがち.</p>
</div>
                  <div class="left">
<h2>Gevent</h2>
<pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">spamegg</span>(a):
    b <span style="color: #666666">=</span> spam()
    <span style="color: #008000; font-weight: bold">return</span> egg(a, b)
</pre></div>
</pre>
<h2>Tornado</h2>
<pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">class</span> <span style="color: #0000FF; font-weight: bold">SpameHamEgg</span>(<span style="color: #008000">object</span>):

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">bake</span>(<span style="color: #008000">self</span>, a, callback):
        <span style="color: #008000">self</span><span style="color: #666666">.</span>a <span style="color: #666666">=</span> a
        <span style="color: #008000">self</span><span style="color: #666666">.</span>callback <span style="color: #666666">=</span> callback
        spam(callback<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>on_spam)

    <span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">on_spam</span>(<span style="color: #008000">self</span>, b):
        egg(<span style="color: #008000">self</span><span style="color: #666666">.</span>a, b, callback<span style="color: #666666">=</span><span style="color: #008000">self</span><span style="color: #666666">.</span>callback)
</pre></div>
</pre>
</div>
                  <div class="right">
<h2>tornado.gen</h2>
<p><small>ジェネレータを使ったコルーチン.</small></p>
<pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">from</span> <span style="color: #0000FF; font-weight: bold">tornado</span> <span style="color: #008000; font-weight: bold">import</span> gen
<span style="color: #AA22FF">@gen.engine</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">spamegg</span>(a):
    b <span style="color: #666666">=</span> yeild spam()
    <span style="color: #008000; font-weight: bold">return</span> egg(a, b)
</pre></div>
</pre>
</div>
                  </section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>エラー処理</h1></header>
              
                
                  <section>
                  <div class="top"><p>callback が呼ばれるのは try-catch ブロックの外.<br />
イベントドリブンでは try-catch に代わる仕組みが必要。</p>
</div>
                  <div class="left">
<h2>Gevent</h2>
<pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">spamegg</span>():
    <span style="color: #008000; font-weight: bold">try</span>:
        a <span style="color: #666666">=</span> spam()
        <span style="color: #008000; font-weight: bold">return</span> egg(a)
    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> e:
        log<span style="color: #666666">.</span>error(e)
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #008000">None</span>
</pre></div>
</pre>
</div>
                  <div class="right">
<h2>Tornado</h2>
<pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">contextlib</span>

<span style="color: #AA22FF">@contextlib.contextmanager</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">log_error</span>():
    <span style="color: #008000; font-weight: bold">try</span>:
        <span style="color: #008000; font-weight: bold">yield</span>
    <span style="color: #008000; font-weight: bold">except</span> <span style="color: #D2413A; font-weight: bold">Exception</span> <span style="color: #008000; font-weight: bold">as</span> e:
        log<span style="color: #666666">.</span>error(e)

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">spamegg</span>():
    <span style="color: #008000; font-weight: bold">with</span> StackContext(log_error):
        spam(callback<span style="color: #666666">=</span>egg)
</pre></div>
</pre>
</div>
                  </section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>ライブラリの対応</h1></header>
              
                
                  <section><h2>Gevent</h2>
<p>多くのライブラリがモンキーパッチで動く.</p>
<p>後から Gevent に対応するのも容易.</p>
<h2>Tornado</h2>
<p>最初から Tornado 用に設計されてないと対応が難しい.</p>
<h2>例: PyMongo</h2>
<p>gevent は monkey patch だけで動く</p>
<p>Tornado に対応させるために Motor が作られた。
(Gevent のような仕組みをTornadoで実現)</p>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>Gevent vs Tornado</h1></header>
              
                
                  <section><p>Tornado, Twisted, node.js はそれぞれイベントドリブンプログラミングのためのフレームワークとしてとてもおもしろい。</p>
<p><br/>
パフォーマンスについても、 Tornado や Twisted の方が若干軽く、しかも PyPy に対応できる。</p>
<p><br/>
Gevent は <strong>今までと同じプログラムの書き方ができ、<br />既存のライブラリを対応させるのも容易</strong></p>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>Gevent の仕組み</h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>Gevent の仕組み</h1></header>
              
                
                  <section><ul>
<li>Greenlet</li>
<li>gevent.core</li>
<li>gevent.hub</li>
</ul>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>Greenlet</h1></header>
              
                
                  <section>
                  <div class="top"><p>明示的に切り替えが必要な軽量スレッド(コルーチン)</p>
</div>
                  <div class="left">
<pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">greenlet</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f1</span>():
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;f1&#39;</span>, <span style="color: #666666">1</span>
    g2<span style="color: #666666">.</span>switch()
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;f1&#39;</span>, <span style="color: #666666">3</span>
    g2<span style="color: #666666">.</span>switch()
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;f1&#39;</span>, <span style="color: #666666">5</span>

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">f2</span>():
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;f2&#39;</span>, <span style="color: #666666">2</span>
    g1<span style="color: #666666">.</span>switch()
    <span style="color: #008000; font-weight: bold">print</span> <span style="color: #BA2121">&#39;f2&#39;</span>, <span style="color: #666666">4</span>
    g1<span style="color: #666666">.</span>switch()

g1 <span style="color: #666666">=</span> greenlet<span style="color: #666666">.</span>greenlet(f1)
g2 <span style="color: #666666">=</span> greenlet<span style="color: #666666">.</span>greenlet(f2)
g1<span style="color: #666666">.</span>switch()
</pre></div>
</pre>
</div>
                  <div class="right">
<p>実行結果</p>
<pre><code>f1 1
f2 2
f1 3
f2 4
f1 5
</code></pre>
</div>
                  </section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>Greenlet vs Thread</h1></header>
              
                
                  <section><ul>
<li>スレッドごとに大きなスタックエリアを取らない</li>
<li>スイッチのオーバーヘッドが軽い</li>
<li>高負荷時のスループット低下が無い</li>
<li>
<p>勝手にスイッチしない(スレッドセーフに書きやすい)</p>
</li>
<li>
<p><strong>ブロックするシステムコールを実行すると、ほかのスレッドに切り替えることができない</strong></p>
</li>
<li>マルチコアを活かせない</li>
</ul>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>gevent.core</h1></header>
              
                
                  <section>
                  <div class="top"><p>libev ラッパー</p>
<p>イベントループを抽象化する.</p>
</div>
                  <div class="left">
<pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">gevent.core</span>
<span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">time</span>

loop <span style="color: #666666">=</span> gevent<span style="color: #666666">.</span>core<span style="color: #666666">.</span>loop()

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">callback</span>():
    <span style="color: #008000; font-weight: bold">print</span> time<span style="color: #666666">.</span>time()

<span style="color: #408080; font-style: italic"># 繰り返しタイマーイベント</span>
timer <span style="color: #666666">=</span> loop<span style="color: #666666">.</span>timer(<span style="color: #666666">1.0</span>, <span style="color: #666666">1.0</span>)
timer<span style="color: #666666">.</span>start(callback)
loop<span style="color: #666666">.</span>run()
</pre></div>
</pre>
</div>
                  <div class="right">
<p>実行結果:</p>
<pre><code>1347446334.99
1347446335.99
1347446336.99
1347446337.99
...
</code></pre>
</div>
                  </section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>gevent.hub</h1></header>
              
                
                  <section>
                  <div class="top"><p>イベントループと greenlet を繋げる greenlet</p>
</div>
                  <div class="left">
<pre><div class="highlight"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">gevent.core</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">greenlet</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">time</span>

<span style="color: #408080; font-style: italic"># hub = gevent.get_hub() の簡易版</span>
loop <span style="color: #666666">=</span> gevent<span style="color: #666666">.</span>core<span style="color: #666666">.</span>loop()
hub <span style="color: #666666">=</span> greenlet<span style="color: #666666">.</span>greenlet(loop<span style="color: #666666">.</span>run)

<span style="color: #408080; font-style: italic"># gevent.sleep() の簡易版</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">sleep</span>(seconds):
    timer <span style="color: #666666">=</span> loop<span style="color: #666666">.</span>timer(seconds)
    <span style="color: #408080; font-style: italic"># コールバックで現在の greenlet に switch させる</span>
    timer<span style="color: #666666">.</span>start(greenlet<span style="color: #666666">.</span>getcurrent()<span style="color: #666666">.</span>switch)
    <span style="color: #408080; font-style: italic"># hub に switch してイベントループにもどる</span>
    hub<span style="color: #666666">.</span>switch()

<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">sleeper</span>():
    <span style="color: #008000; font-weight: bold">for</span> _ <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">range</span>(<span style="color: #666666">4</span>):
        <span style="color: #008000; font-weight: bold">print</span> time<span style="color: #666666">.</span>time()
        <span style="color: #408080; font-style: italic"># ブロックする関数として実行可能</span>
        sleep(<span style="color: #666666">1</span>)

sleeper()
hub<span style="color: #666666">.</span>switch()
</pre></div>
</pre>
</div>
                  <div class="right">
<p>実行結果:</p>
<pre><code>1347448193.7
1347448194.7
1347448195.71
1347448196.71
</code></pre>
</div>
                  </section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>gevent.*</h1></header>
              
                
                  <section><ul>
<li>gevent.thread -- thread の置き換え</li>
<li>gevent.socket -- socket の置き換え</li>
<li>gevent.select -- select の置き換え</li>
<li>gevent.queue -- Queue の置き換え</li>
<li>gevent.lock -- threading 内のロックの置き換え</li>
<li>gevent.pywsgi -- wsgi サーバー</li>
<li>gevent.monkey -- モンキーパッチ</li>
<li>etc...</li>
</ul>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>gevent とは何か</h1></header>
              
                
                  <section><ul>
<li>イベントループ (core)</li>
<li>コールバックから greenlet への橋渡し (hub)</li>
<li>標準ライブラリと互換性の高いモジュール群</li>
<li>標準ライブラリを置き換えるモンキーパッチ</li>
<li>tcpserver, wsgiserver, 名前解決などのネットワークライブラリ</li>
<li>その他 pool, Event, AsyncResult などのライブラリ</li>
</ul>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>Gevent を使おう</h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>Gevent を使うチャンス</h1></header>
              
                
                  <section><ul>
<li>WebSocket対応</li>
<li>Comet (long polling) 対応</li>
<li>Streaming API 対応</li>
<li>その他、アプリの機能の一部として大量接続が必要になるケース.</li>
<li>その他、メモリを節約したかったりGILに悩んでいるケース.</li>
</ul>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>Gevent が使えない環境</h1></header>
              
                
                  <section><h2>Python 3</h2>
<ul>
<li>必要性は認識されているが、現在は 1.0 の完成に注力されている.</li>
</ul>
<h2>PyPy</h2>
<ul>
<li>greenlet は CPython 専用。 PyPy に stackless が導入されたのでそれを元に再実装が必要.</li>
<li>Cython + PyPy の環境は整備されてきているが、性能が出るのはまだまだ先.</li>
</ul>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>参考</h1></header>
              
                
                  <section><ul>
<li>
<p><a href="http://sdiehl.github.com/gevent-tutorial">チュートリアル</a></p>
<p>http://sdiehl.github.com/gevent-tutorial</p>
</li>
<li>
<p><a href="http://methane.github.com/gevent-tutorial-ja">日本語訳</a></p>
<p>http://methane.github.com/gevent-tutorial-ja</p>
</li>
<li>
<p>公式サイト</p>
<p>http://gevent.org/</p>
</li>
<li>
<p>プロジェクト</p>
<p>http://code.google.com/p/gevent/</p>
</li>
</ul>
</section>
                
              
          </div>
        
          <div class="slide">
              <header><h1>Thanks.</h1></header>
              
          </div>
        
          <div class="slide">
              <header><h1>...</h1></header>
              
                
                  <section><hr /></section>
                
              
          </div>
        
      </div>
    </div>
    <script>
        main()
    </script>
</body>
</html>